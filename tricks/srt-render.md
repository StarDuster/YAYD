# 字幕渲染策略更新总结 (2026-02-02)

针对双语字幕模式（Bilingual Subtitles）中英文原文显示不完整的问题，本次更新对字幕渲染逻辑进行了重构，不再强制截断为“第一句话”，而是采用更智能的完整保留与排版策略。

## 1. 背景与问题
原有的双语字幕渲染逻辑为了防止屏幕被英文原文占满，采用了 `_first_sentence` 策略：
*   **逻辑**：仅截取原文的第一句话（基于句末标点 `.?!`）。
*   **问题**：
    *   当原文包含多句话时，后续内容被直接丢弃，导致信息缺失。
    *   当原文是长难句（Run-on sentence）且缺乏句末标点时，虽不会丢失内容，但会显示为极长的一行，影响观感。

## 2. 改进后的策略
引入了新的 `_bilingual_source_text` 渲染函数，旨在**完整保留原文语义**的同时优化阅读体验。

### 核心逻辑
1.  **完整保留**：不再丢弃任何原文内容。
2.  **层级切分**：
    *   **Level 1 - 句子切分**：首先按标准句末标点（`.` `?` `!` 及中文对应标点）将原文切分为多个句子。
    *   **Level 2 - 长句优化**：检查切分后的单句长度。
        *   如果单句超过阈值（默认 18 个单词或 110 个字符），则触发**子句智能切分**。
    *   **Level 3 - 子句均匀分组**：
        *   利用 NLP 规则（逗号、分号、从句引导词等）将长句拆解为多个子句（Clauses）。
        *   使用**均匀分组算法**（`_group_clauses_evenly`）将这些子句重新组合成 2 行（或更多），确保每一行的长度尽可能接近，避免“头重脚轻”或“孤儿单词”。
    *   **Level 4 - 词级兜底**：如果子句切分失败或无法满足长度要求，回退到按单词数量均匀强行切分。

### 视觉效果
*   **短句**：保持单行显示。
*   **多句**：按句号换行，多行显示。
*   **长句**：在逗号/分号处智能换行，保持多行显示的平衡感。

## 3. 代码变更
### `src/youdub/steps/synthesize_video.py`
*   **移除**：`_first_sentence` 函数。
*   **新增**：
    *   `_bilingual_source_text`：主入口，负责编排切分逻辑。
    *   `_group_clauses_evenly`：核心算法，负责将子句列表均匀分配到目标行数。
    *   `_unit_weight` / `_tokenize_for_count`：辅助函数，用于计算文本权重（优先 Token 数，CJK 回退到字符数）。
*   **修改**：`generate_bilingual_ass` 和 `generate_srt` 调用新函数替代旧逻辑。
*   **配置**：`_VIDEO_META_VERSION` 升级为 `12`。

### `tests/test_synthesize_video.py`
*   新增单元测试，覆盖多句保留和长句切分场景。

## 4. 依赖复用
新逻辑复用了 `scripts/resplit_by_diarization.py` 中验证过的算法，并进行了适配（Lazy Import `translate` 模块以避免循环依赖），确保了离线脚本和在线渲染逻辑的一致性。
